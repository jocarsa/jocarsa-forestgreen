<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>jocarsa | forestgreen</title>
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Asegura el escalado correcto en dispositivos móviles -->
    <link rel="icon" type="image/svg+xml" href="https://jocarsa.com/static/logo/jocarsa | ForestGreen.svg" />
</head>
<body>
    <!-- Encabezado Superior -->
    <header id="top-header">
        <div class="logo">
            <h1>
                <img src="https://jocarsa.com/static/logo/jocarsa | White.svg" alt="Logo">jocarsa | forestgreen
            </h1>
        </div>
        <div class="auth-buttons">
            <button id="show-login-btn" onclick="showLogin()">Iniciar Sesión</button>
            <button id="show-signup-btn" onclick="showSignup()">Registrarse</button>
            <div id="user-info" class="hidden">
                <img id="profile-photo" src="default-avatar.png" alt="Foto de Perfil" />
                <span id="display-username"></span>
                <input type="file" id="profile-photo-input" accept="image/*" style="display:none" />
                <button onclick="triggerPhotoUpload()">Cambiar Foto</button>
                <button onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <div id="container">
        <!-- INICIO DE SESIÓN -->
        <div id="login-area" class="auth-panel">
            <h2>Iniciar Sesión</h2>
            <input type="text" id="login-username" placeholder="Nombre de Usuario" />
            <input type="password" id="login-password" placeholder="Contraseña" />
            <button onclick="login()">Iniciar Sesión</button>
            <p>¿No tienes una cuenta? <a href="#" onclick="showSignup()">Regístrate</a></p>
        </div>

        <!-- REGISTRO -->
        <div id="signup-area" class="auth-panel hidden">
            <h2>Registrarse</h2>
            <input type="text" id="signup-username" placeholder="Nombre de Usuario" />
            <input type="password" id="signup-password" placeholder="Contraseña" />
            <button onclick="signup()">Registrarse</button>
            <p>¿Ya tienes una cuenta? <a href="#" onclick="showLogin()">Inicia Sesión</a></p>
        </div>

        <!-- APLICACIÓN PRINCIPAL -->
        <div id="main-app" class="main-panel hidden">
            <!-- Panel Izquierdo (Lista de Contactos) -->
            <div class="left-pane" id="left-pane">
                <!-- Buscar y Agregar Contactos -->
                <div class="search-add">
                    <input type="text" id="search-username" placeholder="Buscar o agregar contactos..." />
                    <button onclick="addContact()">Agregar</button>
                </div>
                <!-- Crear Grupo -->
                <div class="create-group">
                    <input type="text" id="new-group-name" placeholder="Nombre del Nuevo Grupo..." />
                    <button onclick="createGroup()">Crear Grupo</button>
                </div>
                <!-- Lista de Contactos y Grupos -->
                <div id="contact-list" class="contact-list">
                    <!-- Los contactos y grupos se cargarán dinámicamente aquí -->
                </div>
            </div>

            <!-- Panel Derecho (Ventana de Chat) -->
            <div class="right-pane" id="right-pane">
                <div class="chat-header" id="chat-header">
                    <!-- Botón de Regresar para Móviles -->
                    <button class="back-button" onclick="showContacts()">←</button>
                    <h3>Selecciona un contacto o grupo para empezar a chatear</h3>
                </div>
                <div id="chat-box" class="chat-box">
                    <!-- Los mensajes del chat aparecerán aquí -->
                </div>
                <div id="typing-indicator" class="typing-indicator hidden">
                    <em>Escribiendo...</em>
                </div>
                <div class="chat-input-area">
                    <button onclick="toggleEmojiPicker()">😊</button>
                    <button onclick="triggerImageUpload()">📷</button>
                    <input type="file" id="chat-image-input" accept="image/*" style="display:none" />
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." oninput="handleTyping()" />
                    <button onclick="sendMessage()">Enviar</button>
                    <div id="emoji-picker" class="emoji-picker hidden">
                        <!-- Lista de emojis -->
                        <span class="emoji" onclick="insertEmoji('😀')">😀</span>
                        <span class="emoji" onclick="insertEmoji('😂')">😂</span>
                        <span class="emoji" onclick="insertEmoji('😍')">😍</span>
                        <span class="emoji" onclick="insertEmoji('👍')">👍</span>
                        <span class="emoji" onclick="insertEmoji('🙏')">🙏</span>
                        <span class="emoji" onclick="insertEmoji('😀')">😀</span>
								<span class="emoji" onclick="insertEmoji('😂')">😂</span>
								<span class="emoji" onclick="insertEmoji('😍')">😍</span>
								<span class="emoji" onclick="insertEmoji('👍')">👍</span>
								<span class="emoji" onclick="insertEmoji('🙏')">🙏</span>
								<span class="emoji" onclick="insertEmoji('😊')">😊</span>
								<span class="emoji" onclick="insertEmoji('🥰')">🥰</span>
								<span class="emoji" onclick="insertEmoji('😎')">😎</span>
								<span class="emoji" onclick="insertEmoji('🤔')">🤔</span>
								<span class="emoji" onclick="insertEmoji('😢')">😢</span>
								<span class="emoji" onclick="insertEmoji('😭')">😭</span>
								<span class="emoji" onclick="insertEmoji('😠')">😠</span>
								<span class="emoji" onclick="insertEmoji('😇')">😇</span>
								<span class="emoji" onclick="insertEmoji('😷')">😷</span>
								<span class="emoji" onclick="insertEmoji('🤒')">🤒</span>
								<span class="emoji" onclick="insertEmoji('🤕')">🤕</span>
								<span class="emoji" onclick="insertEmoji('🤢')">🤢</span>
								<span class="emoji" onclick="insertEmoji('🤮')">🤮</span>
								<span class="emoji" onclick="insertEmoji('😈')">😈</span>
								<span class="emoji" onclick="insertEmoji('👿')">👿</span>
								<span class="emoji" onclick="insertEmoji('👻')">👻</span>
								<span class="emoji" onclick="insertEmoji('💀')">💀</span>
								<span class="emoji" onclick="insertEmoji('👽')">👽</span>
								<span class="emoji" onclick="insertEmoji('🤖')">🤖</span>
								<span class="emoji" onclick="insertEmoji('🎃')">🎃</span>
								<span class="emoji" onclick="insertEmoji('😺')">😺</span>
								<span class="emoji" onclick="insertEmoji('😸')">😸</span>
								<span class="emoji" onclick="insertEmoji('😹')">😹</span>
								<span class="emoji" onclick="insertEmoji('😻')">😻</span>
								<span class="emoji" onclick="insertEmoji('😼')">😼</span>
								<span class="emoji" onclick="insertEmoji('😽')">😽</span>
								<span class="emoji" onclick="insertEmoji('🙀')">🙀</span>
								<span class="emoji" onclick="insertEmoji('😿')">😿</span>
								<span class="emoji" onclick="insertEmoji('😾')">😾</span>
								<span class="emoji" onclick="insertEmoji('👋')">👋</span>
								<span class="emoji" onclick="insertEmoji('🤚')">🤚</span>
								<span class="emoji" onclick="insertEmoji('🖐️')">🖐️</span>
								<span class="emoji" onclick="insertEmoji('✋')">✋</span>
								<span class="emoji" onclick="insertEmoji('🖖')">🖖</span>
								<span class="emoji" onclick="insertEmoji('👌')">👌</span>
								<span class="emoji" onclick="insertEmoji('✌️')">✌️</span>
								<span class="emoji" onclick="insertEmoji('🤞')">🤞</span>
								<span class="emoji" onclick="insertEmoji('🤟')">🤟</span>
								<span class="emoji" onclick="insertEmoji('🤘')">🤘</span>
								<span class="emoji" onclick="insertEmoji('🤙')">🤙</span>
								<span class="emoji" onclick="insertEmoji('👈')">👈</span>
								<span class="emoji" onclick="insertEmoji('👉')">👉</span>
								<span class="emoji" onclick="insertEmoji('👆')">👆</span>
								<span class="emoji" onclick="insertEmoji('👇')">👇</span>
								<span class="emoji" onclick="insertEmoji('🖕')">🖕</span>
								<span class="emoji" onclick="insertEmoji('👍')">👍</span>
								<span class="emoji" onclick="insertEmoji('👎')">👎</span>
								<span class="emoji" onclick="insertEmoji('✊')">✊</span>
								<span class="emoji" onclick="insertEmoji('👊')">👊</span>
								<span class="emoji" onclick="insertEmoji('👏')">👏</span>
								<span class="emoji" onclick="insertEmoji('🙌')">🙌</span>
								<span class="emoji" onclick="insertEmoji('👐')">👐</span>
								<span class="emoji" onclick="insertEmoji('🤲')">🤲</span>
								<span class="emoji" onclick="insertEmoji('🤝')">🤝</span>
								<span class="emoji" onclick="insertEmoji('🙏')">🙏</span>
								<span class="emoji" onclick="insertEmoji('✍️')">✍️</span>
								<span class="emoji" onclick="insertEmoji('💅')">💅</span>
								<span class="emoji" onclick="insertEmoji('🤳')">🤳</span>
								<span class="emoji" onclick="insertEmoji('💪')">💪</span>
								<span class="emoji" onclick="insertEmoji('🦾')">🦾</span>
								<span class="emoji" onclick="insertEmoji('🦿')">🦿</span>
								<span class="emoji" onclick="insertEmoji('🖕')">🖕</span>
								<span class="emoji" onclick="insertEmoji('🧠')">🧠</span>
								<span class="emoji" onclick="insertEmoji('🫀')">🫀</span>
								<span class="emoji" onclick="insertEmoji('🫁')">🫁</span>
								<span class="emoji" onclick="insertEmoji('💋')">💋</span>
								<span class="emoji" onclick="insertEmoji('💌')">💌</span>
								<span class="emoji" onclick="insertEmoji('💘')">💘</span>
								<span class="emoji" onclick="insertEmoji('💝')">💝</span>
								<span class="emoji" onclick="insertEmoji('💖')">💖</span>
								<span class="emoji" onclick="insertEmoji('💗')">💗</span>
								<span class="emoji" onclick="insertEmoji('💓')">💓</span>
								<span class="emoji" onclick="insertEmoji('💞')">💞</span>
								<span class="emoji" onclick="insertEmoji('💕')">💕</span>
								<span class="emoji" onclick="insertEmoji('💟')">💟</span>
								<span class="emoji" onclick="insertEmoji('❣️')">❣️</span>
								<span class="emoji" onclick="insertEmoji('💔')">💔</span>
								<span class="emoji" onclick="insertEmoji('❤️')">❤️</span>
								<span class="emoji" onclick="insertEmoji('🧡')">🧡</span>
								<span class="emoji" onclick="insertEmoji('💛')">💛</span>
								<span class="emoji" onclick="insertEmoji('💚')">💚</span>
								<span class="emoji" onclick="insertEmoji('💙')">💙</span>
								<span class="emoji" onclick="insertEmoji('💜')">💜</span>
								<span class="emoji" onclick="insertEmoji('🤎')">🤎</span>
								<span class="emoji" onclick="insertEmoji('🖤')">🖤</span>
								<span class="emoji" onclick="insertEmoji('🤍')">🤍</span>
								<span class="emoji" onclick="insertEmoji('💯')">💯</span>
								<span class="emoji" onclick="insertEmoji('🔟')">🔟</span>
								<span class="emoji" onclick="insertEmoji('🔢')">🔢</span>
								<span class="emoji" onclick="insertEmoji('💢')">💢</span>
								<span class="emoji" onclick="insertEmoji('💥')">💥</span>
								<span class="emoji" onclick="insertEmoji('💫')">💫</span>
								<span class="emoji" onclick="insertEmoji('💦')">💦</span>
								<span class="emoji" onclick="insertEmoji('💨')">💨</span>
								<span class="emoji" onclick="insertEmoji('🕳️')">🕳️</span>
								<span class="emoji" onclick="insertEmoji('💣')">💣</span>
								<span class="emoji" onclick="insertEmoji('💬')">💬</span>
								<span class="emoji" onclick="insertEmoji('👁️‍🗨️')">👁️‍🗨️</span>
								<span class="emoji" onclick="insertEmoji('🗨️')">🗨️</span>
								<span class="emoji" onclick="insertEmoji('🗯️')">🗯️</span>
								<span class="emoji" onclick="insertEmoji('💭')">💭</span>
								<span class="emoji" onclick="insertEmoji('💤')">💤</span>
								<span class="emoji" onclick="insertEmoji('👋')">👋</span>
								<span class="emoji" onclick="insertEmoji('🤚')">🤚</span>
								<span class="emoji" onclick="insertEmoji('🖐️')">🖐️</span>
								<span class="emoji" onclick="insertEmoji('✋')">✋</span>
								<span class="emoji" onclick="insertEmoji('🖖')">🖖</span>
								<span class="emoji" onclick="insertEmoji('👌')">👌</span>
								<span class="emoji" onclick="insertEmoji('👍')">👍</span>
								<span class="emoji" onclick="insertEmoji('👎')">👎</span>
								<span class="emoji" onclick="insertEmoji('✌️')">✌️</span>
								<span class="emoji" onclick="insertEmoji('🤞')">🤞</span>
								<span class="emoji" onclick="insertEmoji('🤟')">🤟</span>
								<span class="emoji" onclick="insertEmoji('🤘')">🤘</span>
								<span class="emoji" onclick="insertEmoji('🤙')">🤙</span>
								<span class="emoji" onclick="insertEmoji('👈')">👈</span>
								<span class="emoji" onclick="insertEmoji('👉')">👉</span>
								<span class="emoji" onclick="insertEmoji('👆')">👆</span>
								<span class="emoji" onclick="insertEmoji('👇')">👇</span>
								<span class="emoji" onclick="insertEmoji('🖕')">🖕</span>
								<span class="emoji" onclick="insertEmoji('✍️')">✍️</span>
								<span class="emoji" onclick="insertEmoji('💅')">💅</span>
								<span class="emoji" onclick="insertEmoji('🤳')">🤳</span>
								<span class="emoji" onclick="insertEmoji('💪')">💪</span>
								<span class="emoji" onclick="insertEmoji('🦾')">🦾</span>
								<span class="emoji" onclick="insertEmoji('🦿')">🦿</span>
								<span class="emoji" onclick="insertEmoji('🧠')">🧠</span>
								<span class="emoji" onclick="insertEmoji('🫀')">🫀</span>
								<span class="emoji" onclick="insertEmoji('🫁')">🫁</span>
								<span class="emoji" onclick="insertEmoji('💋')">💋</span>
								<span class="emoji" onclick="insertEmoji('💌')">💌</span>
								<span class="emoji" onclick="insertEmoji('💘')">💘</span>
								<span class="emoji" onclick="insertEmoji('💝')">💝</span>
								<span class="emoji" onclick="insertEmoji('💖')">💖</span>
								<span class="emoji" onclick="insertEmoji('💗')">💗</span>
								<span class="emoji" onclick="insertEmoji('💓')">💓</span>
								<span class="emoji" onclick="insertEmoji('💞')">💞</span>
								<span class="emoji" onclick="insertEmoji('💕')">💕</span>
								<span class="emoji" onclick="insertEmoji('💟')">💟</span>
								<span class="emoji" onclick="insertEmoji('❣️')">❣️</span>
								<span class="emoji" onclick="insertEmoji('💔')">💔</span>
								<span class="emoji" onclick="insertEmoji('❤️')">❤️</span>
								<span class="emoji" onclick="insertEmoji('🧡')">🧡</span>
								<span class="emoji" onclick="insertEmoji('💛')">💛</span>
								<span class="emoji" onclick="insertEmoji('💚')">💚</span>
								<span class="emoji" onclick="insertEmoji('💙')">💙</span>
								<span class="emoji" onclick="insertEmoji('💜')">💜</span>
								<span class="emoji" onclick="insertEmoji('🤎')">🤎</span>
								<span class="emoji" onclick="insertEmoji('🖤')">🖤</span>
								<span class="emoji" onclick="insertEmoji('🤍')">🤍</span>
								<span class="emoji" onclick="insertEmoji('💯')">💯</span>
								<span class="emoji" onclick="insertEmoji('🔟')">🔟</span>
								<span class="emoji" onclick="insertEmoji('🔢')">🔢</span>
								<span class="emoji" onclick="insertEmoji('💢')">💢</span>
								<span class="emoji" onclick="insertEmoji('💥')">💥</span>
								<span class="emoji" onclick="insertEmoji('💫')">💫</span>
								<span class="emoji" onclick="insertEmoji('💦')">💦</span>
								<span class="emoji" onclick="insertEmoji('💨')">💨</span>
								<span class="emoji" onclick="insertEmoji('🕳️')">🕳️</span>
								<span class="emoji" onclick="insertEmoji('💣')">💣</span>
								<span class="emoji" onclick="insertEmoji('💬')">💬</span>
								<span class="emoji" onclick="insertEmoji('👁️‍🗨️')">👁️‍🗨️</span>
								<span class="emoji" onclick="insertEmoji('🗨️')">🗨️</span>
								<span class="emoji" onclick="insertEmoji('🗯️')">🗯️</span>
								<span class="emoji" onclick="insertEmoji('💭')">💭</span>
								<span class="emoji" onclick="insertEmoji('💤')">💤</span>
                        <!-- Agrega más emojis según sea necesario -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Externo -->
    <script>
    document.getElementById('main-app').classList.add('hidden');
        // Estado del Front-end
        let currentUserId = null;
        let currentContactId = null;
        let currentContactType = 'user'; // 'user' o 'group'
        let refreshInterval = null; // para sondeo
        let currentContactUsername = ''; // Para rastrear el nombre de usuario del contacto al cargar mensajes
        let lastMessageId = 0; // Para rastrear el último mensaje cargado
        let typingTimeout = null; // Para manejar el tiempo de espera del indicador de escritura
        let isTyping = false; // Para rastrear si el usuario está escribiendo actualmente
		
        // Mostrar/ocultar secciones
        function showLogin() {
            hideAllAuthPanels();
            document.getElementById('login-area').classList.remove('hidden');
        }

        function showSignup() {
            hideAllAuthPanels();
            document.getElementById('signup-area').classList.remove('hidden');
        }

        function showMain() {
            hideAllAuthPanels();
				 document.getElementById('main-app').classList.remove('hidden');
				 document.getElementById('user-info').classList.remove('hidden');
				 document.getElementById('show-login-btn').classList.add('hidden');
				 document.getElementById('show-signup-btn').classList.add('hidden');
				 loadProfilePhoto(); // Cargar foto de perfil cuando se muestra la aplicación principal

            // Ajustar paneles según el dispositivo
            if (isMobile()) {
                showContacts(); // Mostrar lista de contactos por defecto en móviles
            } else {
                document.getElementById('left-pane').classList.remove('hidden-on-mobile');
                document.getElementById('right-pane').classList.remove('hidden-on-mobile');
            }
        }

        function hideAllAuthPanels() {
            document.getElementById('login-area').classList.add('hidden');
            document.getElementById('signup-area').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        // Función útil para verificar si el dispositivo es móvil
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Mostrar Lista de Contactos (para botón de regresar en móviles)
        function showContacts() {
            if (isMobile()) {
                document.getElementById('right-pane').classList.add('hidden-on-mobile');
                document.getElementById('left-pane').classList.remove('hidden-on-mobile');
                // Reiniciar encabezado del chat
                document.getElementById('chat-header').innerHTML = `
                    <button class="back-button" onclick="showContacts()">←</button>
                    <h3>Selecciona un contacto o grupo para empezar a chatear</h3>
                `;
                document.getElementById('chat-box').innerHTML = '';
                document.getElementById('typing-indicator').classList.add('hidden');
            }
        }

        // Mostrar Panel de Chat (después de seleccionar un contacto)
        function showChat() {
				 if (currentContactId && isMobile()) {
					  document.getElementById('left-pane').classList.add('hidden-on-mobile');
					  document.getElementById('right-pane').classList.remove('hidden-on-mobile');
				 }
			}

        // Pantalla inicial
        showLogin();

        // Iniciar Sesión
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const formData = new FormData();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                currentUserId = data.user_id;
                document.getElementById('display-username').textContent = username;
                showMain();
                loadContactsAndGroups();
                startPolling();
                // Asegurar que ambos paneles sean visibles en escritorio
                if (!isMobile()) {
                    document.querySelector("#main-app").style.display = "flex";
                }
            } else {
                alert(data.message);
            }
        }

        // Registrarse
        async function signup() {
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;

            const formData = new FormData();
            formData.append('action', 'signup');
            formData.append('username', username);
            formData.append('password', password);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Registro exitoso! Ahora puedes iniciar sesión.');
                showLogin();
            } else {
                alert(data.message);
            }
        }

        // Cerrar Sesión
        function logout() {
            currentUserId = null;
            currentContactId = null;
            currentContactType = 'user';
            currentContactUsername = '';
            lastMessageId = 0;
            clearInterval(refreshInterval);
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('show-login-btn').classList.remove('hidden');
            document.getElementById('show-signup-btn').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            showLogin();
        }

        // Agregar Contacto
        async function addContact() {
            const searchUser = document.getElementById('search-username').value;
            if (!searchUser) return;

            const formData = new FormData();
            formData.append('action', 'add_contact');
            formData.append('user_id', currentUserId);
            formData.append('contact_username', searchUser);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('Contacto agregado exitosamente');
                loadContactsAndGroups();
                document.getElementById('search-username').value = '';
            } else {
                alert(data.message);
            }
        }

        // Crear Grupo
        async function createGroup() {
            const groupName = document.getElementById('new-group-name').value.trim();
            if (!groupName) {
                alert('Por favor, ingresa un nombre para el grupo.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'create_group');
            formData.append('name', groupName);
            formData.append('admin_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Grupo creado exitosamente!');
                document.getElementById('new-group-name').value = '';
                loadContactsAndGroups();
            } else {
                alert(data.message);
            }
        }

        // Cargar Contactos y Grupos
        async function loadContactsAndGroups() {
				 console.log('Loading contacts and groups...');
				 await loadContacts();
				 await loadGroups();
				 console.log('Contacts and groups loaded.');
			}

        // Cargar contactos individuales
        async function loadContacts() {
            const formData = new FormData();
            formData.append('action', 'get_contacts');
            formData.append('user_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            const contactList = document.getElementById('contact-list');
            // Eliminar contactos individuales existentes
            const existingContacts = contactList.querySelectorAll('.contact-item:not(.group)');
            existingContacts.forEach(el => el.remove());

            if (data.success && data.contacts) {
                for (const contact of data.contacts) {
                    const div = document.createElement('div');
                    div.classList.add('contact-item');
                    div.dataset.contactId = contact.id;
                    div.innerHTML = `
                        <div class="avatar" id="avatar-${contact.id}"></div>
                        <span>${contact.username}</span>
                    `;
                    div.onclick = () => {
                        currentContactId = contact.id;
                        currentContactType = 'user';
                        currentContactUsername = contact.username;
                        lastMessageId = 0; // Reiniciar para nueva conversación
                        loadMessages(contact.username);
                        showChat(); // Mostrar panel de chat en móviles
                    };
                    contactList.appendChild(div);

                    // Cargar y establecer la foto de perfil del contacto
                    loadContactProfilePhoto(contact.id, `avatar-${contact.id}`);
                }
            }
        }

        // Cargar grupos
        async function loadGroups() {
            const formData = new FormData();
            formData.append('action', 'get_groups');
            formData.append('user_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            const contactList = document.getElementById('contact-list');
            // Eliminar grupos existentes
            const existingGroups = contactList.querySelectorAll('.contact-item.group');
            existingGroups.forEach(el => el.remove());

            if (data.success && data.groups) {
                data.groups.forEach(group => {
                    const div = document.createElement('div');
                    div.classList.add('contact-item', 'group');
                    div.dataset.groupId = group.id;
                    div.innerHTML = `
                        <div class="avatar" id="avatar-group-${group.id}"></div>
                        <span>${group.name} <small>(Grupo)</small></span>
                    `;
                    div.onclick = () => {
                        currentContactId = group.id;
                        currentContactType = 'group';
                        loadGroupMessages(group.id, group.name);
                        showChat(); // Mostrar panel de chat en móviles
                    };
                    div.ondblclick = () => {
                        if (group.admin_id === currentUserId) {
                            manageGroup(group.id, group.name);
                        } else {
                            alert('Solo el administrador del grupo puede gestionarlo.');
                        }
                    };
                    contactList.appendChild(div);

                    // Cargar y establecer una foto de grupo por defecto o la foto del administrador
                    loadGroupProfilePhoto(group.id, `avatar-group-${group.id}`);
                });
            }
        }

        // Cargar y establecer la foto de perfil de un contacto
        async function loadContactProfilePhoto(contactId, elementId) {
            try {
                const response = await fetch(`https://forestgreen.jocarsa.com/server.php?action=get_profile_photo&user_id=${contactId}`);
                if (response.ok && response.headers.get('Content-Type').startsWith('image/')) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    document.getElementById(elementId).style.backgroundImage = `url(${imageUrl})`;
                } else {
                    // Manejar avatar por defecto
                    document.getElementById(elementId).style.backgroundImage = `url('default-avatar.png')`;
                }
            } catch (error) {
                console.error(`Error cargando foto de perfil para el contacto ${contactId}:`, error);
                document.getElementById(elementId).style.backgroundImage = `url('default-avatar.png')`;
            }
        }

        // Cargar y establecer la foto de perfil de un grupo (usando una foto de grupo por defecto)
        async function loadGroupProfilePhoto(groupId, elementId) {
            // Para simplificar, usando una foto de grupo por defecto. Alternativamente, se puede obtener la foto del administrador o una imagen específica del grupo.
            document.getElementById(elementId).style.backgroundImage = `url('default-group-avatar.png')`;
        }

        // Cargar mensajes para un contacto individual
        async function loadMessages(contactUsername) {
            const formData = new FormData();
            formData.append('action', 'get_messages');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('type', 'user');
            formData.append('last_message_id', lastMessageId); // Para carga incremental

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success && data.messages) {
                const chatBox = document.getElementById('chat-box');
                data.messages.forEach(msg => {
                    if (msg.id > lastMessageId) {
                        const div = document.createElement('div');
                        div.classList.add('chat-message');
                        div.classList.add(msg.from_id == currentUserId ? 'from-me' : 'from-them');
                        div.dataset.messageId = msg.id; // Para recibos de lectura

                        if (msg.message) {
                            div.textContent = msg.message;
                        }

                        // Manejar Recibos de Lectura
                        if (msg.read_at && msg.from_id != currentUserId) {
                            const readReceipt = document.createElement('span');
                            readReceipt.classList.add('read-receipt');
                            readReceipt.textContent = '✓✓'; // Doble marca de verificación
                            div.appendChild(readReceipt);
                        }

                        if (msg.id) { // Asumiendo que cada mensaje tiene un ID único
                            // Obtener y mostrar imagen si existe
                            fetch(`https://forestgreen.jocarsa.com/server.php?action=get_image&message_id=${msg.id}`)
                                .then(response => {
                                    if (response.ok && response.headers.get('Content-Type').startsWith('image/')) {
                                        return response.blob();
                                    }
                                })
                                .then(blob => {
                                    if (blob) {
                                        const imgUrl = URL.createObjectURL(blob);
                                        const img = document.createElement('img');
                                        img.src = imgUrl;
                                        img.alt = 'Imagen';
                                        img.classList.add('chat-image');
                                        div.appendChild(document.createElement('br'));
                                        div.appendChild(img);
                                    }
                                })
                                .catch(error => console.error('Error cargando imagen:', error));
                        }

                        chatBox.appendChild(div);
                        lastMessageId = Math.max(lastMessageId, msg.id);
                    }
                });
                chatBox.scrollTop = chatBox.scrollHeight;

                // Actualizar encabezado del chat
                document.getElementById('chat-header').innerHTML = `
                    <button class="back-button" onclick="showContacts()">←</button>
                    <h3>Chat con ${contactUsername}</h3>
                `;

                showChat(); // Asegurar que el panel de chat sea visible en móviles

                // Marcar mensajes como leídos
                markMessagesAsRead();
            }
        }

        // Cargar mensajes para un grupo
        async function loadGroupMessages(groupId, groupName) {
            const formData = new FormData();
            formData.append('action', 'get_messages');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', groupId);
            formData.append('type', 'group');
            formData.append('last_message_id', lastMessageId); // Para carga incremental

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success && data.messages) {
                const chatBox = document.getElementById('chat-box');
                data.messages.forEach(msg => {
                    if (msg.id > lastMessageId) {
                        const div = document.createElement('div');
                        div.classList.add('chat-message');
                        div.classList.add(msg.from_id == currentUserId ? 'from-me' : 'from-them');
                        div.dataset.messageId = msg.id; // Para recibos de lectura

                        if (msg.message) {
                            div.textContent = msg.message;
                        }

                        // Manejar Recibos de Lectura
                        if (msg.read_at && msg.from_id != currentUserId) {
                            const readReceipt = document.createElement('span');
                            readReceipt.classList.add('read-receipt');
                            readReceipt.textContent = '✓✓'; // Doble marca de verificación
                            div.appendChild(readReceipt);
                        }

                        if (msg.id) { // Asumiendo que cada mensaje tiene un ID único
                            // Obtener y mostrar imagen si existe
                            fetch(`https://forestgreen.jocarsa.com/server.php?action=get_image&message_id=${msg.id}`)
                                .then(response => {
                                    if (response.ok && response.headers.get('Content-Type').startsWith('image/')) {
                                        return response.blob();
                                    }
                                })
                                .then(blob => {
                                    if (blob) {
                                        const imgUrl = URL.createObjectURL(blob);
                                        const img = document.createElement('img');
                                        img.src = imgUrl;
                                        img.alt = 'Imagen';
                                        img.classList.add('chat-image');
                                        div.appendChild(document.createElement('br'));
                                        div.appendChild(img);
                                    }
                                })
                                .catch(error => console.error('Error cargando imagen:', error));
                        }

                        chatBox.appendChild(div);
                        lastMessageId = Math.max(lastMessageId, msg.id);
                    }
                });
                chatBox.scrollTop = chatBox.scrollHeight;

                // Actualizar encabezado del chat
                document.getElementById('chat-header').innerHTML = `
                    <button class="back-button" onclick="showContacts()">←</button>
                    <h3>Grupo: ${groupName}</h3>
                `;

                showChat(); // Asegurar que el panel de chat sea visible en móviles

                // Marcar mensajes como leídos
                markMessagesAsRead();
            }
        }

        // Enviar mensaje
        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message && !document.getElementById('chat-image-input').files[0]) return;

            const formData = new FormData();
            formData.append('action', 'send_message');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('message', message);
            formData.append('type', currentContactType); // 'user' o 'group'

            // Verificar si se ha seleccionado una imagen
            const imageFile = document.getElementById('chat-image-input').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                chatInput.value = '';
                document.getElementById('chat-image-input').value = ''; // Reiniciar el input de imagen
                if (currentContactType === 'user') {
                    await loadMessages(currentContactUsername);
                } else if (currentContactType === 'group') {
                    const groupName = document.querySelector('.chat-header h3').textContent.replace('Grupo: ', '');
                    await loadGroupMessages(currentContactId, groupName);
                }
            } else {
                alert(data.message);
            }
        }

        // Sondeo para nuevos mensajes
			function startPolling() {
				 if (refreshInterval) clearInterval(refreshInterval);
				 refreshInterval = setInterval(async () => {
					  console.log('Polling: currentContactId:', currentContactId);
					  if (currentContactId) {
						   if (currentContactType === 'user') {
						       await loadMessages(currentContactUsername);
						   } else if (currentContactType === 'group') {
						       const groupName = document.querySelector('.chat-header h3').textContent.replace('Grupo: ', '');
						       await loadGroupMessages(currentContactId, groupName);
						   }
					  }
				 }, 3000); // every 3 seconds
			}

        // Gestionar Grupo (Renombrar, Eliminar, Agregar/Eliminar Miembros)
        async function manageGroup(groupId, groupName) {
            const action = prompt(`Gestionar Grupo "${groupName}":\n1. Renombrar Grupo\n2. Eliminar Grupo\n3. Agregar Miembro\n4. Eliminar Miembro\nIngresa el número de opción:`);

            switch(action) {
                case '1':
                    const newName = prompt('Ingresa el nuevo nombre del grupo:');
                    if (newName) {
                        await renameGroupRequest(groupId, newName);
                    }
                    break;
                case '2':
                    if (confirm(`¿Estás seguro de que deseas eliminar el grupo "${groupName}"?`)) {
                        await deleteGroupRequest(groupId);
                    }
                    break;
                case '3':
                    const usernameToAdd = prompt('Ingresa el nombre de usuario para agregar al grupo:');
                    if (usernameToAdd) {
                        await addMemberToGroup(groupId, usernameToAdd);
                    }
                    break;
                case '4':
                    const usernameToRemove = prompt('Ingresa el nombre de usuario para eliminar del grupo:');
                    if (usernameToRemove) {
                        await removeMemberFromGroup(groupId, usernameToRemove);
                    }
                    break;
                default:
                    alert('Opción inválida.');
            }
        }

        async function renameGroupRequest(groupId, newName) {
            const formData = new FormData();
            formData.append('action', 'rename_group');
            formData.append('group_id', groupId);
            formData.append('new_name', newName);
            formData.append('user_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Grupo renombrado exitosamente!');
                loadContactsAndGroups();
            } else {
                alert(data.message);
            }
        }

        async function deleteGroupRequest(groupId) {
            const formData = new FormData();
            formData.append('action', 'delete_group');
            formData.append('group_id', groupId);
            formData.append('user_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Grupo eliminado exitosamente!');
                loadContactsAndGroups();
                // Si el grupo eliminado estaba abierto actualmente, limpiar el chat
                if (currentContactId === groupId && currentContactType === 'group') {
                    currentContactId = null;
                    currentContactType = 'user';
                    currentContactUsername = '';
                    lastMessageId = 0;
                    document.getElementById('chat-box').innerHTML = '';
                    document.getElementById('typing-indicator').classList.add('hidden');
                    document.getElementById('chat-header').innerHTML = `
                        <button class="back-button" onclick="showContacts()">←</button>
                        <h3>Selecciona un contacto o grupo para empezar a chatear</h3>
                    `;
                }
            } else {
                alert(data.message);
            }
        }

        async function addMemberToGroup(groupId, username) {
            const userId = await getUserIdByUsername(username);
            if (!userId) {
                alert('Usuario no encontrado.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'add_to_group');
            formData.append('group_id', groupId);
            formData.append('user_id', userId);
            formData.append('admin_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Usuario agregado al grupo exitosamente!');
                loadContactsAndGroups();
            } else {
                alert(data.message);
            }
        }

        async function removeMemberFromGroup(groupId, username) {
            const userId = await getUserIdByUsername(username);
            if (!userId) {
                alert('Usuario no encontrado.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'remove_from_group');
            formData.append('group_id', groupId);
            formData.append('user_id', userId);
            formData.append('admin_id', currentUserId);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Usuario eliminado del grupo exitosamente!');
                loadContactsAndGroups();
            } else {
                alert(data.message);
            }
        }

        async function getUserIdByUsername(username) {
            const formData = new FormData();
            formData.append('action', 'get_user_id');
            formData.append('username', username);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                return data.user_id;
            } else {
                return null;
            }
        }

        // Manejar la tecla Enter para enviar mensajes
        const chatInput = document.querySelector("#chat-input");
        chatInput.onkeypress = function(e){
            if(e.key === 'Enter'){
                e.preventDefault(); // Asegurar que solo se ejecute este código
                sendMessage();
            }
        }

        // Funciones para la Subida de Fotos de Perfil

        // Función para activar el input de archivo oculto
        function triggerPhotoUpload() {
            document.getElementById('profile-photo-input').click();
        }

        // Manejar la selección de foto de perfil
        document.getElementById('profile-photo-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                uploadProfilePhoto(file);
            }
        });

        // Subir foto de perfil al servidor
        async function uploadProfilePhoto(file) {
            const formData = new FormData();
            formData.append('action', 'upload_profile_photo');
            formData.append('user_id', currentUserId);
            formData.append('photo', file);

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('¡Foto de perfil actualizada exitosamente!');
                loadProfilePhoto();
            } else {
                alert(data.message);
            }
        }

        // Cargar y mostrar la foto de perfil del usuario
        async function loadProfilePhoto() {
            try {
                const response = await fetch(`https://forestgreen.jocarsa.com/server.php?action=get_profile_photo&user_id=${currentUserId}`);
                if (response.ok && response.headers.get('Content-Type').startsWith('image/')) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    document.getElementById('profile-photo').src = imageUrl;
                } else {
                    // Manejar imagen por defecto o error
                    document.getElementById('profile-photo').src = 'default-avatar.png';
                }
            } catch (error) {
                console.error('Error cargando foto de perfil:', error);
                document.getElementById('profile-photo').src = 'default-avatar.png';
            }
        }

        // Funciones del Selector de Emojis

        // Alternar la visibilidad del selector de emojis
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.classList.toggle('hidden');
        }

        // Insertar el emoji seleccionado en el input de chat
        function insertEmoji(emoji) {
            const chatInput = document.getElementById('chat-input');
            const start = chatInput.selectionStart;
            const end = chatInput.selectionEnd;
            const text = chatInput.value;
            chatInput.value = text.slice(0, start) + emoji + text.slice(end);
            chatInput.focus();
            // Mover la posición del cursor después del emoji
            chatInput.selectionStart = chatInput.selectionEnd = start + emoji.length;
            // Ocultar el selector de emojis después de la selección
            document.getElementById('emoji-picker').classList.add('hidden');
        }

        // Opcional: Cerrar el selector de emojis al hacer clic fuera
        document.addEventListener('click', function(event) {
            const picker = document.getElementById('emoji-picker');
            const emojiButton = event.target.closest('button[onclick="toggleEmojiPicker()"]');
            if (!emojiButton && !picker.contains(event.target)) {
                picker.classList.add('hidden');
            }
        });

        // Funciones de Subida de Imágenes

        // Función para activar el input de archivo de imagen oculto
        function triggerImageUpload() {
            document.getElementById('chat-image-input').click();
        }

        // Manejar la selección de imagen
        document.getElementById('chat-image-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Opcionalmente, se puede implementar el envío directo de la imagen sin requerir que el usuario haga clic en 'Enviar'
                // Para simplificar, permitiremos que el usuario haga clic en 'Enviar' para enviar la imagen
            }
        });

        // Manejar el redimensionamiento de la ventana para ajustar paneles
        window.addEventListener('resize', function() {
    console.log('Window resized. Width:', window.innerWidth);
    if (!isMobile()) {
        // Ensure both panels are visible
        document.getElementById('left-pane').classList.remove('hidden-on-mobile');
        document.getElementById('right-pane').classList.remove('hidden-on-mobile');
        document.getElementById('right-pane').classList.remove('full-width');
    } else {
        // If on mobile and no contact is selected, show contacts pane
        if (!currentContactId) {
            document.getElementById('right-pane').classList.add('hidden-on-mobile');
            document.getElementById('left-pane').classList.remove('hidden-on-mobile');
        }
    }
});

        // Verificación inicial al cargar
        window.addEventListener('load', function() {
            if (isMobile()) {
                document.getElementById('right-pane').classList.add('hidden-on-mobile');
                document.getElementById('left-pane').classList.remove('hidden-on-mobile');
            }
        });

        // Funciones del Indicador de Escritura

        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                notifyTypingStatus(true);
            }

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                notifyTypingStatus(false);
            }, 3000); // 3 segundos de inactividad
        }

        async function notifyTypingStatus(status) {
            const formData = new FormData();
            formData.append('action', 'typing_status');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('type', currentContactType); // 'user' o 'group'
            formData.append('is_typing', status ? '1' : '0');

            await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
        }

        async function fetchTypingStatus() {
            if (!currentContactId) return;

            const formData = new FormData();
            formData.append('action', 'get_typing_status');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('type', currentContactType); // 'user' o 'group'

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            const typingIndicator = document.getElementById('typing-indicator');
            if (data.success && data.is_typing) {
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        // Funciones de Recibos de Lectura

        async function markMessagesAsRead() {
            if (!currentContactId) return;

            const formData = new FormData();
            formData.append('action', 'mark_as_read');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('type', currentContactType); // 'user' o 'group'

            await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
        }

        async function fetchReadReceipts() {
            if (!currentContactId) return;

            const formData = new FormData();
            formData.append('action', 'get_read_receipts');
            formData.append('user_id', currentUserId);
            formData.append('contact_id', currentContactId);
            formData.append('type', currentContactType); // 'user' o 'group'

            const response = await fetch('https://forestgreen.jocarsa.com/server.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success && data.read_receipts) {
                data.read_receipts.forEach(receipt => {
                    const messageElement = document.querySelector(`.chat-message[data-message-id="${receipt.message_id}"]`);
                    if (messageElement && !messageElement.querySelector('.read-receipt')) {
                        const receiptElement = document.createElement('span');
                        receiptElement.classList.add('read-receipt');
                        receiptElement.textContent = '✓✓'; // Doble marca de verificación
                        messageElement.appendChild(receiptElement);
                    }
                });
            }
        }

        // Obtener periódicamente el estado de escritura y los recibos de lectura
        setInterval(() => {
            fetchTypingStatus();
            fetchReadReceipts();
        }, 2000); // cada 2 segundos
    </script>
</body>
</html>

